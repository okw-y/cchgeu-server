<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <style>
        :root {
            --bg: #000000; --text: #FFFFFF; --card-bg: #0d0d0d;
            --border: #2a2a2a; --hover: #1a1a1a; --accent: #FFFFFF;
            --red: #ff5555; --red-bg: rgba(255, 85, 85, 0.1);
            --font: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }
        body { font-family: var(--font); background: var(--bg); color: var(--text); margin: 0; padding: 24px; font-size: 14px; }
        body.modal-open { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 24px; }
        .header h1 { font-size: 24px; margin: 0; font-weight: 600; }
        .btns { display: flex; gap: 12px; }
        .btn { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; transition: 0.2s; }
        .btn:hover { background: var(--hover); }
        .btn.active { background: #333; border-color: #555; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .card { background: var(--card-bg); padding: 16px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .full { grid-column: 1 / -1; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .kpi .val { font-size: 24px; font-weight: 700; }
        .kpi .lbl { font-size: 13px; color: #888; margin-top: 4px; }
        .c-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .c-title { font-size: 16px; font-weight: 600; margin: 0; }
        .filters { display: flex; gap: 4px; background: #1a1a1a; padding: 3px; border-radius: 6px; }
        .filters button { background: none; border: none; color: #888; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-family: inherit; }
        .filters button.active { background: #333; color: #fff; }
        .date-range { display: none; gap: 6px; align-items: center; border: 1px solid var(--border); padding: 3px; border-radius: 6px; }
        .date-range.show { display: flex; }
        .date-range input { background: #1a1a1a; border: none; color: #fff; border-radius: 4px; padding: 4px; font-family: inherit; font-size: 11px; }
        .chart-box { position: relative; height: 300px; width: 100%; }
        .tbl-wrap { max-height: 450px; overflow-y: auto; }
        .tbl { width: 100%; border-collapse: collapse; font-size: 12px; }
        .tbl th, .tbl td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        .tbl th { color: #888; cursor: pointer; position: sticky; top: 0; background: var(--card-bg); }
        .tbl tr:hover { background: var(--hover); }
        .pill { padding: 3px 8px; border-radius: 10px; font-weight: 600; font-size: 11px; }
        .s-2xx { background: #1e4620; color: #a6f6a9; }
        .s-4xx { background: #5d4218; color: #fcc273; }
        .s-5xx { background: #5c1f1f; color: var(--red); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(4px); }
        .m-content { background: var(--card-bg); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 10px; border: 1px solid var(--border); padding: 20px; }
        .m-head { display: flex; justify-content: space-between; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .m-title { font-size: 18px; font-weight: 600; }
        .m-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; line-height: 1; }
        .info-t { width: 100%; border-collapse: collapse; margin-bottom: 16px; border: 1px solid var(--border); }
        .info-t td { padding: 8px; border-bottom: 1px solid var(--border); word-break: break-all; }
        .info-t td:first-child { color: #888; width: 140px; }
        .err-box { background: var(--red-bg); border: 1px solid var(--red); color: #ffcccc; padding: 10px; border-radius: 6px; white-space: pre-wrap; margin-top: 10px; }
        .ad-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; inset: 0; background: #333; transition: .3s; border-radius: 20px; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #fff; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); background: #000; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Dashboard</h1>
        <div class="btns">
            <button class="btn" onclick="openAdModal()">Ads Settings</button>
            <button class="btn" onclick="loadData()">Update Data</button>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="card kpi"><div id="kpi-req" class="val">-</div><div class="lbl">Requests</div></div>
        <div class="card kpi"><div id="kpi-time" class="val">-</div><div class="lbl">Avg Latency</div></div>
        <div class="card kpi"><div id="kpi-err" class="val">-</div><div class="lbl">Error Rate</div></div>
        <div class="card kpi"><div id="kpi-users" class="val">-</div><div class="lbl">Users</div></div>
    </div>

    <div class="grid">
        <div class="card full">
            <div class="c-head">
                <h2 class="c-title">Requests Activity</h2>
                <div class="filters-wrap">
                    <div class="filters" data-id="reqTime">
                        <button class="active" data-v="24">24h</button><button data-v="168">Week</button><button data-v="720">Month</button><button data-v="all">All</button><button data-v="cust">Custom</button>
                    </div>
                    <div class="date-range" id="dr-reqTime">
                        <input type="date" id="s-reqTime"><input type="date" id="e-reqTime"><button class="btn" onclick="applyCust('reqTime')">Go</button>
                    </div>
                </div>
            </div>
            <div class="chart-box"><canvas id="c-reqTime"></canvas></div>
        </div>

        <div class="card full">
            <div class="c-head">
                <h2 class="c-title">New Users</h2>
                <div class="filters-wrap">
                    <div class="filters" data-id="newUser">
                        <button class="active" data-v="24">24h</button><button data-v="168">Week</button><button data-v="720">Month</button><button data-v="all">All</button><button data-v="cust">Custom</button>
                    </div>
                    <div class="date-range" id="dr-newUser">
                        <input type="date" id="s-newUser"><input type="date" id="e-newUser"><button class="btn" onclick="applyCust('newUser')">Go</button>
                    </div>
                </div>
            </div>
            <div class="chart-box"><canvas id="c-newUser"></canvas></div>
        </div>

        <div class="card"><div class="c-head"><h2 class="c-title">Status Codes</h2></div><div class="chart-box"><canvas id="c-status"></canvas></div></div>
        <div class="card"><div class="c-head"><h2 class="c-title">Faculties (Users)</h2></div><div class="chart-box"><canvas id="c-faculty"></canvas></div></div>
        <div class="card"><div class="c-head"><h2 class="c-title">Groups (Users)</h2></div><div class="chart-box"><canvas id="c-group"></canvas></div></div>

        <div class="card full">
            <div class="c-head">
                <h2 class="c-title">Requests Log</h2>
                <div class="filters-wrap">
                    <div class="filters" data-id="tbl">
                        <button class="active" data-v="24">24h</button><button data-v="168">Week</button><button data-v="720">Month</button><button data-v="all">All</button><button data-v="cust">Custom</button>
                    </div>
                    <div class="date-range" id="dr-tbl">
                        <input type="date" id="s-tbl"><input type="date" id="e-tbl"><button class="btn" onclick="applyCust('tbl')">Go</button>
                    </div>
                </div>
            </div>
            <div class="tbl-wrap">
                <table class="tbl">
                    <thead><tr><th onclick="sortTbl('timestamp')">Time</th><th onclick="sortTbl('method')">Method</th><th onclick="sortTbl('path')">Path</th><th onclick="sortTbl('status')">Status</th><th onclick="sortTbl('responseTime')">ms</th><th onclick="sortTbl('ip')">IP</th></tr></thead>
                    <tbody id="tbl-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-req" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div class="m-content">
            <div class="m-head"><h3 class="m-title">Request Details</h3><button class="m-close" onclick="document.getElementById('modal-req').style.display='none'">&times;</button></div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="modal-ads" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div class="m-content">
            <div class="m-head"><h3 class="m-title">Ads Settings</h3><button class="m-close" onclick="document.getElementById('modal-ads').style.display='none'">&times;</button></div>
            <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
                <span>Toggle All</span><button class="btn" onclick="toggleAllAds()">Apply</button>
            </div>
            <div id="ads-list"></div>
        </div>
    </div>

    <script>
        dayjs.extend(dayjs_plugin_isSameOrAfter); dayjs.extend(dayjs_plugin_isSameOrBefore);
        let DATA = { req: [], usr: [] };
        let STATE = {
            ranges: { reqTime: 24, newUser: 24, tbl: 24 },
            sort: { col: 'timestamp', dir: 'desc' }
        };
        let CHARTS = {};

        const getPill = s => `<span class="pill ${s>=500?'s-5xx':s>=400?'s-4xx':'s-2xx'}">${s}</span>`;

        function filter(data, range, key) {
            if(!data.length) return [];
            if(range === 'all') return data;
            if(typeof range === 'object') {
                const s = dayjs(range.s), e = dayjs(range.e);
                return data.filter(i => { const d = dayjs(i[key]); return d.isSameOrAfter(s,'day') && d.isSameOrBefore(e,'day'); });
            }
            const limit = dayjs().subtract(range, 'hour');
            return data.filter(i => dayjs(i[key]).isAfter(limit));
        }

        async function loadData() {
            document.querySelector('.btn:nth-child(2)').textContent = 'Loading...';
            try {
                const res = await fetch('/dashboard-data');
                if(!res.ok) throw 1;
                const json = await res.json();
                DATA.req = json.requests;
                DATA.usr = json.users;
                renderAll();
            } catch(e) { alert('Load Error'); }
            document.querySelector('.btn:nth-child(2)').textContent = 'Update Data';
        }

        function renderAll() {
            const rAll = DATA.req, uAll = DATA.usr;
            const rTime = filter(rAll, STATE.ranges.reqTime, 'timestamp');
            const uTime = filter(uAll, STATE.ranges.newUser, 'join_date');
            const rTbl = filter(rAll, STATE.ranges.tbl, 'timestamp');

            document.getElementById('kpi-req').innerText = rAll.length;
            document.getElementById('kpi-time').innerText = (rAll.reduce((a,b)=>a+b.responseTime,0)/rAll.length||0).toFixed(0)+' ms';
            document.getElementById('kpi-err').innerText = ((rAll.filter(i=>i.status>=400).length/rAll.length||0)*100).toFixed(1)+'%';
            document.getElementById('kpi-users').innerText = uAll.length;

            lineChart('c-reqTime', rTime, 'timestamp', STATE.ranges.reqTime);
            lineChart('c-newUser', uTime, 'join_date', STATE.ranges.newUser);
            pieChart('c-status', rAll, x => Math.floor(x.status/100)+'xx');
            pieChart('c-faculty', uAll, x => x.faculty);
            pieChart('c-group', uAll, x => x.group);

            renderTbl(rTbl);
            renderAds();
        }

        function lineChart(id, data, key, range) {
            const ctx = document.getElementById(id).getContext('2d');
            let fmt = 'HH:mm';
            if(range === 'all' || typeof range === 'object') fmt = 'DD/MM/YY';
            else if(range > 48) fmt = 'DD MMM';

            const grp = {};
            data.forEach(i => {
                let t = dayjs(i[key]);
                let k = (range===24) ? t.startOf('hour').format() : t.startOf('day').format();
                grp[k] = (grp[k]||0)+1;
            });

            const labs = Object.keys(grp).sort();
            const vals = labs.map(k => grp[k]);
            const fmtLabs = labs.map(k => dayjs(k).format(fmt));

            if(CHARTS[id]) { CHARTS[id].data.labels=fmtLabs; CHARTS[id].data.datasets[0].data=vals; CHARTS[id].update(); return; }
            CHARTS[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: fmtLabs, datasets: [{ data: vals, borderColor: '#fff', backgroundColor: 'rgba(255,255,255,0.1)', fill: true, tension: 0.3, pointRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#888', maxTicksLimit: 10 }, grid: { color: '#222' } }, y: { ticks: { color: '#888' }, grid: { color: '#222' } } } }
            });
        }

        function pieChart(id, data, fn) {
            const ctx = document.getElementById(id).getContext('2d');
            const cnt = {};
            data.forEach(i => {
                const k = fn(i);
                if(k && k !== 'Unknown' && k !== '') cnt[k] = (cnt[k]||0)+1;
            });
            const labs = Object.keys(cnt);
            const vals = Object.values(cnt);

            if(CHARTS[id]) { CHARTS[id].data.labels=labs; CHARTS[id].data.datasets[0].data=vals; CHARTS[id].update(); return; }
            CHARTS[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labs, datasets: [{ data: vals, backgroundColor: ['#eee','#ccc','#aaa','#888','#666'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', boxWidth: 12 } } } }
            });
        }

        function renderTbl(data) {
            data.sort((a,b) => {
                let x = a[STATE.sort.col], y = b[STATE.sort.col];
                return (x>y ? 1 : x<y ? -1 : 0) * (STATE.sort.dir==='asc'?1:-1);
            });
            const html = data.map(i =>
                `<tr onclick="showReq(${i.id})"><td>${dayjs(i.timestamp).format('DD/MM HH:mm:ss')}</td><td>${i.method}</td><td>${i.path}</td><td>${getPill(i.status)}</td><td>${i.responseTime}</td><td>${i.ip}</td></tr>`
            ).join('');
            document.getElementById('tbl-body').innerHTML = html;
        }

        function showReq(id) {
            const r = DATA.req.find(x => x.id === id);
            if(!r) return;
            const tbl = o => Object.entries(o||{}).map(([k,v]) => `<tr><td>${k}</td><td>${typeof v==='object'?JSON.stringify(v,null,2):v}</td></tr>`).join('');
            const err = (r.status>=500 && r.error) ? `<div class="err-box">${r.error}</div>` : '';
            let h = '';
            try { h = typeof r.headers === 'string' ? JSON.parse(r.headers) : r.headers; } catch { h = r.headers; }
            let b = '';
            try { b = typeof r.body === 'string' ? JSON.parse(r.body) : r.body; } catch { b = r.body; }

            document.getElementById('m-body').innerHTML = `
                <table class="info-t">
                    <tr><td>Time</td><td>${r.timestamp}</td></tr>
                    <tr><td>IP</td><td>${r.ip}</td></tr>
                    <tr><td>Status</td><td>${getPill(r.status)}</td></tr>
                    <tr><td>Group</td><td>${r.group||'-'}</td></tr>
                </table>
                <h4>Headers</h4><table class="info-t">${tbl(h)}</table>
                <h4>Body</h4><table class="info-t">${tbl(b)}</table>
                ${err}`;
            document.getElementById('modal-req').style.display = 'flex';
        }

        function renderAds() {
            const h = DATA.usr.map(u =>
                `<div class="ad-item"><span>${u.username} (${u.client_id})</span><label class="switch"><input type="checkbox" ${u.ad_enabled?'checked':''} onchange="updAd('${u.client_id}',this.checked)"><span class="slider"></span></label></div>`
            ).join('');
            document.getElementById('ads-list').innerHTML = h;
        }

        async function updAd(cid, val) {
            await fetch('/v2/toggleAds', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({client_id:cid, enabled:val}) });
            DATA.usr.find(u=>u.client_id===cid).ad_enabled = val;
        }

        function toggleAllAds() {
            const val = !DATA.usr.every(u=>u.ad_enabled);
            DATA.usr.forEach(u => { u.ad_enabled = val; updAd(u.client_id, val); });
            renderAds();
        }

        function openAdModal() { document.getElementById('modal-ads').style.display='flex'; renderAds(); }

        function applyCust(id) {
            const s = document.getElementById('s-'+id).value;
            const e = document.getElementById('e-'+id).value;
            if(s && e) { STATE.ranges[id] = {s,e}; renderAll(); }
        }

        function sortTbl(col) {
            STATE.sort.dir = (STATE.sort.col === col && STATE.sort.dir === 'desc') ? 'asc' : 'desc';
            STATE.sort.col = col;
            renderAll();
        }

        document.querySelectorAll('.filters button').forEach(b => {
            b.onclick = function() {
                const p = this.parentElement;
                const v = this.getAttribute('data-v');
                p.querySelectorAll('button').forEach(x => x.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('dr-'+p.dataset.id).classList.toggle('show', v==='cust');
                if(v!=='cust') { STATE.ranges[p.dataset.id] = v==='all'?'all':Number(v); renderAll(); }
            }
        });

        loadData();
    </script>
</body>
</html>